// Prisma Schema for E-Voting System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// User accounts (Admin, Officer, Candidate)
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(CANDIDATE)
  regNo         String?   @map("reg_no")
  program       String?
  staffId       String?   @map("staff_id")
  status        String    @default("ACTIVE")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdBy     String?   @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  createdCandidates Candidate[]
  createdOfficers  User[]         @relation("CreatedOfficers")
  createdByUser    User?          @relation("CreatedOfficers", fields: [createdBy], references: [id])
  passwordResets    PasswordReset[]

  @@map("users")
}

enum UserRole {
  ADMIN
  OFFICER
  CANDIDATE
}

// Election Positions
model Position {
  id              String    @id @default(uuid())
  name            String
  seats           Int       @default(1)
  nominationOpens DateTime  @map("nomination_opens_at")
  nominationCloses DateTime @map("nomination_closes_at")
  votingOpens     DateTime  @map("voting_opens_at")
  votingCloses    DateTime  @map("voting_closes_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  candidates Candidate[]
  votes      Vote[]

  @@map("positions")
}

// Candidates (Nominations)
model Candidate {
  id          String           @id @default(uuid())
  positionId  String           @map("position_id")
  userId      String           @map("user_id")
  name        String
  program     String
  manifestoUrl String?        @map("manifesto_url")
  photoUrl    String?          @map("photo_url")
  status      CandidateStatus  @default(SUBMITTED)
  reason      String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  // Relations
  position Position @relation(fields: [positionId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes    Vote[]

  @@unique([positionId, userId])
  @@map("candidates")
}

enum CandidateStatus {
  SUBMITTED
  APPROVED
  REJECTED
}

// Eligible Voters (from CSV import)
model EligibleVoter {
  id       String   @id @default(uuid())
  regNo    String   @unique @map("reg_no")
  name     String
  email    String?
  phone    String?
  program  String?
  status   String   @default("ELIGIBLE")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  verifications Verification[]
  ballots       Ballot[]

  @@map("eligible_voters")
}

// OTP Verifications
model Verification {
  id          String    @id @default(uuid())
  voterId     String    @map("voter_id")
  method      String    // "email" or "sms"
  otpHash     String    @map("otp_hash")
  issuedAt    DateTime  @default(now()) @map("issued_at")
  expiresAt   DateTime  @map("expires_at")
  verifiedAt  DateTime? @map("verified_at")
  ballotToken String?   @map("ballot_token")
  consumedAt  DateTime? @map("consumed_at")

  // Relations
  voter EligibleVoter @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@map("verifications")
}

// Ballots (issued to voters)
model Ballot {
  id         String    @id @default(uuid())
  voterId    String    @map("voter_id")
  token      String    @unique
  status     String    @default("ACTIVE") // ACTIVE, CONSUMED
  issuedAt   DateTime  @default(now()) @map("issued_at")
  consumedAt DateTime? @map("consumed_at")

  // Relations
  voter EligibleVoter @relation(fields: [voterId], references: [id], onDelete: Cascade)
  votes Vote[]

  @@map("ballots")
}

// Votes (secret ballot - no voter PII)
model Vote {
  id         String   @id @default(uuid())
  ballotId   String   @map("ballot_id")
  positionId String   @map("position_id")
  candidateId String  @map("candidate_id")
  castAt     DateTime @default(now()) @map("cast_at")

  // Relations
  ballot    Ballot    @relation(fields: [ballotId], references: [id], onDelete: Cascade)
  position  Position  @relation(fields: [positionId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([ballotId, positionId]) // One vote per position per ballot
  @@map("votes")
}

// Password Reset (for candidates)
model PasswordReset {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  otpHash     String    @map("otp_hash")
  issuedAt    DateTime  @default(now()) @map("issued_at")
  expiresAt   DateTime  @map("expires_at")
  verifiedAt  DateTime? @map("verified_at")
  resetAt     DateTime? @map("reset_at")
  consumedAt  DateTime? @map("consumed_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Audit Log (immutable, append-only)
model AuditLog {
  id        String   @id @default(uuid())
  actorType String   @map("actor_type") // "admin", "officer", "candidate", "voter", "system"
  actorId   String?  @map("actor_id")
  action    String
  entity    String?  // "position", "candidate", "vote", etc.
  entityId  String?  @map("entity_id")
  payload   Json?    // Additional data
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}
